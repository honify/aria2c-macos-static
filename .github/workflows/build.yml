name: Build aria2c Static

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  ARIA2_VERSION: "1.37.0"

jobs:
  build-arm64:
    name: Build for Apple Silicon (arm64)
    runs-on: macos-14  # Apple Silicon runner
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Xcode and accept license
        run: |
          sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
          sudo xcodebuild -license accept || true
          xcode-select -p
          gcc --version
      
      - name: Install dependencies
        run: |
          brew install autoconf automake libtool pkg-config
      
      - name: Build aria2c
        run: |
          chmod +x build-static.sh
          ./build-static.sh arm64
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: aria2c-arm64
          path: aria2c-arm64
          retention-days: 1

  build-x86_64:
    name: Build for Intel (x86_64)
    runs-on: macos-15  # Intel runner
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Xcode and accept license
        run: |
          sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
          sudo xcodebuild -license accept || true
          xcode-select -p
          gcc --version
      
      - name: Install dependencies
        run: |
          brew install autoconf automake libtool pkg-config
      
      - name: Build aria2c
        run: |
          chmod +x build-static.sh
          ./build-static.sh x86_64
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: aria2c-x86_64
          path: aria2c-x86_64
          retention-days: 1

  create-universal:
    name: Create Universal Binary
    needs: [build-arm64, build-x86_64]
    runs-on: macos-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download arm64 binary
        uses: actions/download-artifact@v4
        with:
          name: aria2c-arm64
      
      - name: Download x86_64 binary
        uses: actions/download-artifact@v4
        with:
          name: aria2c-x86_64
      
      - name: Create universal binary
        run: |
          chmod +x build-universal.sh
          chmod +x aria2c-arm64
          chmod +x aria2c-x86_64
          ./build-universal.sh
      
      - name: Create checksums
        run: |
          shasum -a 256 aria2c-arm64 > checksums.txt
          shasum -a 256 aria2c-x86_64 >> checksums.txt
          shasum -a 256 aria2c-universal >> checksums.txt
      
      - name: Create release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            aria2c-arm64
            aria2c-x86_64
            aria2c-universal
            checksums.txt
          body: |
            ## aria2c ${{ env.ARIA2_VERSION }} - Static Builds for macOS
            
            ### Download
            
            - **Universal Binary** (Recommended): `aria2c-universal`
            - **Apple Silicon only**: `aria2c-arm64`
            - **Intel only**: `aria2c-x86_64`
            
            ### Usage
            
            ```bash
            # Download
            curl -LO https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/aria2c-universal
            
            # Make executable
            chmod +x aria2c-universal
            
            # Run
            ./aria2c-universal --version
            ```
            
            ### Verification
            
            ```bash
            # Verify checksum
            shasum -a 256 -c checksums.txt
            
            # Verify architectures
            file aria2c-universal
            lipo -info aria2c-universal
            ```
            
            Built from aria2 [release-${{ env.ARIA2_VERSION }}](https://github.com/aria2/aria2/releases/tag/release-${{ env.ARIA2_VERSION }})
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload artifacts (non-release)
        if: "!startsWith(github.ref, 'refs/tags/')"
        uses: actions/upload-artifact@v4
        with:
          name: aria2c-binaries
          path: |
            aria2c-arm64
            aria2c-x86_64
            aria2c-universal
            checksums.txt
