name: Build aria2c Static

on:
  workflow_dispatch:

env:
  ARIA2_VERSION: "1.37.0"

jobs:
  build-arm64:
    name: Build for Apple Silicon (arm64)
    runs-on: macos-14  # Apple Silicon runner
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Verify compiler
        run: |
          clang --version
          which clang
          echo "int main() { return 0; }" > test.c
          clang -o test test.c
          ./test
          echo "✅ Compiler works!"
      
      - name: Install dependencies
        run: |
          brew install autoconf automake libtool pkg-config
      
      - name: Build aria2c
        run: |
          chmod +x build-static.sh
          ./build-static.sh arm64
      
      - name: Verify and prepare binary
        run: |
          ls -la
          file aria2c-arm64
          ./aria2c-arm64 --version
          shasum -a 256 aria2c-arm64 > aria2c-arm64.sha256
      
      - name: Create release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            aria2c-arm64
            aria2c-arm64.sha256

  build-x86_64:
    name: Build for Intel (x86_64)
    runs-on: macos-15  # Intel runner
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Verify compiler
        run: |
          clang --version
          which clang
          echo "int main() { return 0; }" > test.c
          clang -o test test.c
          ./test
          echo "✅ Compiler works!"
      
      - name: Install dependencies
        run: |
          brew install autoconf automake libtool pkg-config
      
      - name: Build aria2c
        run: |
          chmod +x build-static.sh
          ./build-static.sh x86_64
      
      - name: Verify and prepare binary
        run: |
          ls -la
          file aria2c-x86_64
          ./aria2c-x86_64 --version
          shasum -a 256 aria2c-x86_64 > aria2c-x86_64.sha256
      
      - name: Create release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            aria2c-x86_64
            aria2c-x86_64.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload artifacts (non-release)
        if: "!startsWith(github.ref, 'refs/tags/')"
        uses: actions/upload-artifact@v4
        with:
          name: aria2c-binaries
          path: |
            aria2c-arm64
            aria2c-x86_64
            aria2c-universal
            checksums.txt
